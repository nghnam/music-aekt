{% extends "base.html" %}

{% block head %}
<title>Music AEKT</title>
{% endblock %}

{% block body %}
<div class="ui main text container" style="text-align: center">
  <br>
  <h1 class="ui header">Music AEKT</h1>
  <p></p>

  <form class="ui form">
    <div class="field">
      <div class="ui icon input">
        <input type="text" name="music_link" placeholder="Paste link mp3.zing.vn ...">
        <i class="paste icon"></i>
      </div>
    </div>

    <div class="field">
      <div class="ui checkbox">
        <input type="checkbox" tabindex="0" class="hidden" name="terms">
        <label>Tôi hứa sẽ <strong><u>không next</u></strong> bài của các bạn</label>
      </div>
    </div>


    <input type="submit" class="ui button teal submit" value="Thêm vào playlist">

    <div class="ui error message"></div>
  </form>

  <br>
  <h3 class="ui header">Nhạc đang chơi</h3>

  <div class="ui icon buttons">
    <button class="ui button mini disabled play-act" id="ctrl-prev"><i class="backward icon"></i></button>
    <button class="ui button mini disabled play-act" id="ctrl-play"><i class="icon play"></i></button>
    <button class="ui button mini disabled play-act" id="ctrl-next"><i class="forward icon"></i></button>
  </div>


  <div class="ui progress tiny" id="play-progress">
    <div class="bar disabled"></div>
    <div class="label"> <i class="notched circle loading icon"></i> Đang tải thông tin</div>
  </div>

  <br>
  <h3 class="ui header">List nhạc</h3>

  <div class="ui middle aligned divided list" style="text-align: left">
    <div class="item">
      <div class="right floated content">
        <div class="ui button mini"><i class="play icon"></i></div>
      </div>
      <div class="content">
        Lena
      </div>
    </div>
    <div class="item">
      <div class="right floated content">
        <div class="ui button mini"><i class="play icon"></i></div>
      </div>
      <div class="content">
        <i class="sound icon"></i>
        /tmp/Hay-Ra-Khoi-Nguoi-Do-Di-Phan-Manh-Quynh.mp3
      </div>
    </div>
    <div class="item">
      <div class="right floated content">
        <div class="ui button mini"><i class="play icon"></i></div>
      </div>
      <div class="content">
        Mark
      </div>
    </div>
    <div class="item">
      <div class="right floated content">
        <div class="ui button mini"><i class="play icon"></i></div>
      </div>
      <div class="content">
        Molly
      </div>
    </div>
  </div>

</div>

{% endblock %}

{% block scripts %}
<script>
// init checkbox
$('.ui.checkbox')
.checkbox()
;

// handle form
$('.ui.form')
.form({
  fields: {
    music_link: {
      identifier: 'music_link',
      rules: [
        {
          type   : 'empty',
          prompt : 'Link chưa đúng'
        }
      ]
    },
    terms: {
      identifier: 'terms',
      rules: [
        {
          type   : 'checked',
          prompt : 'Chưa hứa !!!!'
        }
      ]
    }
  },
  onSuccess: function(event, fields){
    console.log(this);
    event.preventDefault();

    $.post( "/", $( this ).serialize(), function( data ) {
      alert('OK, Chờ tý đang down về list nhạc');
    });
  }
})
;
////////////////// END handle form

function getSongData(data){
  song = {
    Title: data.SongTitle,
    Artist: data.Artist,
    State: data.State
  }

  // set song name
  if(data.SongTitle == ''){
    song.Title = data.File
  }

  song.DisplayName = song.Title

  if(song.Artist != '') {
    song.DisplayName = song.Title + ' - ' + song.Artist
  }

  return song
}

function setControl(data) {
  if(data.State == 'PLAY') {
    $('.play-act').each(function(){
      $(this).removeClass('disabled');
    });
    $('#ctrl-play > i').removeClass('play').addClass('pause')
  }

  if(data.State == 'PAUSE') {
    $('.play-act').each(function(){
      $(this).removeClass('disabled');
    });
    $('#ctrl-play > i').removeClass('pause').addClass('play')
  }

  if(data.State == 'STOP') {
    $('.play-act').each(function(){
      $(this).addClass('disabled');
    });
    $('#ctrl-play > i').removeClass('pause').addClass('play')
  }

}

// handle current song

function setProgress(opts){
  $('#play-progress').progress(opts);
}

function loadPlayer(){
  $.get( "/info", function( data ) {
    console.log(data)

    // Stopping
    if(data.State == 'STOP'){
      var noPlay = {
        percent: 0,
        value: 0,
        text: {
          active: 'Đang không chơi bài nào'
        }
      }
      setProgress(noPlay);
      $('#play-progress').removeClass('teal');
    }

    // Playing
    if(data.State == 'PLAY' || data.State == 'PAUSE'){
      song = getSongData(data)
      var noPlay = {
        percent: (data.CurrentSec / data.TotalSec) * 100,
        text: {
          active: song.DisplayName
        }
      }
      setProgress(noPlay);
      $('#play-progress').addClass('teal');
    }

    setControl(data);
  });
}
loadPlayer();
setInterval(function(){
  loadPlayer();
}, 5000);


////////////////// END handle current song

/// control
function doAction(act){
  $.get( "/" + act, function( data ) {
    loadPlayer();
  })
}

$('#ctrl-play').click(function(event){
  if($(this).children('i').hasClass('play')){
    // click to play
    doAction('play')

  }else if ($(this).children('i').hasClass('pause')) {
    // click to pause
    doAction('pause')
  }
});

$('#ctrl-prev').click(function() {
  doAction('prev')
})
$('#ctrl-next').click(function() {
  doAction('next')
})
////////////////////// END control
</script>
{% endblock %}
